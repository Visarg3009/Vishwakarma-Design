name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy on EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.EC2_PATH }}

            echo "Pulling latest code..."
            git pull origin main

            echo "Building frontend..."
            npm install
            npm run build

            echo "Building backend..."
            cd backend
            npm install
            npm run build

            echo "Restarting PM2..."
            pm2 restart portfolio-email-api || pm2 start dist/server.js --name portfolio-email-api
            pm2 save
          EOF
